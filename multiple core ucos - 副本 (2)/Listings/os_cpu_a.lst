


ARM Macro Assembler    Page 1 


    1 00000000         ;*******************************************************
                       *************************************************
    2 00000000         ;                                              uC/OS-II
    3 00000000         ;                                        The Real-Time K
                       ernel
    4 00000000         ;
    5 00000000         ;                    Copyright 1992-2021 Silicon Laborat
                       ories Inc. www.silabs.com
    6 00000000         ;
    7 00000000         ;                                 SPDX-License-Identifie
                       r: APACHE-2.0
    8 00000000         ;
    9 00000000         ;               This software is subject to an open sour
                       ce license and is distributed by
   10 00000000         ;                Silicon Laboratories Inc. pursuant to t
                       he terms of the Apache License,
   11 00000000         ;                    Version 2.0 available at www.apache
                       .org/licenses/LICENSE-2.0.
   12 00000000         ;
   13 00000000         ;*******************************************************
                       *************************************************
   14 00000000         
   15 00000000         ;*******************************************************
                       *************************************************
   16 00000000         ;
   17 00000000         ;                                             ARMv7-M Po
                       rt
   18 00000000         ;
   19 00000000         ; Filename  : os_cpu_a.asm
   20 00000000         ; Version   : V2.93.01
   21 00000000         ;*******************************************************
                       *************************************************
   22 00000000         ; For       : ARMv7-M Cortex-M
   23 00000000         ; Mode      : Thumb-2 ISA
   24 00000000         ; Toolchain : ARM C Compiler
   25 00000000         ;*******************************************************
                       *************************************************
   26 00000000         ; Note(s)   : (1) This port supports the ARM Cortex-M3, 
                       Cortex-M4 and Cortex-M7 architectures.
   27 00000000         ;             (2) It has been tested with the following 
                       Hardware Floating Point Unit.
   28 00000000         ;                 (a) Single-precision: FPv4-SP-D16-M an
                       d FPv5-SP-D16-M
   29 00000000         ;                 (b) Double-precision: FPv5-D16-M
   30 00000000         ;*******************************************************
                       *************************************************
   31 00000000         
   32 00000000         ;*******************************************************
                       *************************************************
   33 00000000         ;                                          PUBLIC FUNCTI
                       ONS
   34 00000000         ;*******************************************************
                       *************************************************
   35 00000000         
   36 00000000                 EXTERN           OSRunning   ; External referenc
                                                            es
   37 00000000                 EXTERN           OSPrioCur
   38 00000000                 EXTERN           OSPrioHighRdy
   39 00000000                 EXTERN           OSTCBCur



ARM Macro Assembler    Page 2 


   40 00000000                 EXTERN           OSTCBHighRdy
   41 00000000                 EXTERN           OSIntExit
   42 00000000                 EXTERN           OSTaskSwHook
   43 00000000                 EXTERN           OS_CPU_ExceptStkBase
   44 00000000                 EXTERN           OS_KA_BASEPRI_Boundary
   45 00000000         
   46 00000000         
   47 00000000                 EXPORT           OSStartHighRdy ; Functions decl
                                                            ared in this file
   48 00000000                 EXPORT           OS_CPU_SR_Save
   49 00000000                 EXPORT           OS_CPU_SR_Restore
   50 00000000                 EXPORT           OSCtxSw
   51 00000000                 EXPORT           OSIntCtxSw
   52 00000000                 EXPORT           PendSV_Handler
   53 00000000                 EXPORT           SystemInit1
   54 00000000         
   55 00000000         
   56 00000000         
   57 00000000         ;*******************************************************
                       *************************************************
   58 00000000         ;                                               EQUATES
   59 00000000         ;*******************************************************
                       *************************************************
   60 00000000         
   61 00000000 E000ED04 
                       NVIC_INT_CTRL
                               EQU              0xE000ED04  ; Interrupt control
                                                             state register.
   62 00000000 E000ED22 
                       NVIC_SYSPRI14
                               EQU              0xE000ED22  ; System priority r
                                                            egister (priority 1
                                                            4).
   63 00000000 000000FF 
                       NVIC_PENDSV_PRI
                               EQU              0xFF        ; PendSV priority v
                                                            alue (lowest).
   64 00000000 10000000 
                       NVIC_PENDSVSET
                               EQU              0x10000000  ; Value to trigger 
                                                            PendSV exception.
   65 00000000         
   66 00000000         
   67 00000000         ;*******************************************************
                       *************************************************
   68 00000000         ;                                     CODE GENERATION DI
                       RECTIVES
   69 00000000         ;*******************************************************
                       *************************************************
   70 00000000         
   71 00000000                 AREA             |.text|, CODE, READONLY, ALIGN=
2
   72 00000000                 THUMB
   73 00000000                 REQUIRE8
   74 00000000                 PRESERVE8
   75 00000000         
   76 00000000         
   77 00000000         
   78 00000000         ;*******************************************************



ARM Macro Assembler    Page 3 


                       *************************************************
   79 00000000         ;                                   CRITICAL SECTION MET
                       HOD 3 FUNCTIONS
   80 00000000         ;
   81 00000000         ; Description : Disable/Enable Kernel aware interrupts b
                       y preserving the state of BASEPRI.  Generally speaking,
   82 00000000         ;               the state of the BASEPRI interrupt excep
                       tion processing is stored in the local variable
   83 00000000         ;               'cpu_sr' & Kernel Aware interrupts are t
                       hen disabled ('cpu_sr' is allocated in all functions
   84 00000000         ;               that need to disable Kernel aware interr
                       upts). The previous BASEPRI interrupt state is restored
   85 00000000         ;               by copying 'cpu_sr' into the BASEPRI reg
                       ister.
   86 00000000         ;
   87 00000000         ; Prototypes  : OS_CPU_SR  OS_CPU_SR_Save   (OS_CPU_SR  
                       new_basepri);
   88 00000000         ;               void       OS_CPU_SR_Restore(OS_CPU_SR  
                       cpu_sr);
   89 00000000         ;
   90 00000000         ;
   91 00000000         ; Note(s)     : 1) These functions are used in general l
                       ike this:
   92 00000000         ;
   93 00000000         ;                  void Task (void *p_arg)
   94 00000000         ;                  {
   95 00000000         ;                  #if OS_CRITICAL_METHOD == 3          
                       /* Allocate storage for CPU status register  */
   96 00000000         ;                      OS_CPU_SR  cpu_sr;
   97 00000000         ;                  #endif
   98 00000000         ;
   99 00000000         ;                          :
  100 00000000         ;                          :
  101 00000000         ;                      OS_ENTER_CRITICAL();             
                       /* cpu_sr = OS_CPU_SR_Save(new_basepri);     */
  102 00000000         ;                          :
  103 00000000         ;                          :
  104 00000000         ;                      OS_EXIT_CRITICAL();              
                       /* OS_CPU_RestoreSR(cpu_sr);                 */
  105 00000000         ;                          :
  106 00000000         ;                          :
  107 00000000         ;                  }
  108 00000000         ;
  109 00000000         ;               2) Increasing priority using a write to 
                       BASEPRI does not take effect immediately.
  110 00000000         ;                  (a) IMPLICATION  This erratum means t
                       hat the instruction after an MSR to boost BASEPRI
  111 00000000         ;                      might incorrectly be preempted by
                        an insufficient high priority exception.
  112 00000000         ;
  113 00000000         ;                  (b) WORKAROUND  The MSR to boost BASE
                       PRI can be replaced by the following code sequence:
  114 00000000         ;
  115 00000000         ;                      CPSID i
  116 00000000         ;                      MSR to BASEPRI
  117 00000000         ;                      DSB
  118 00000000         ;                      ISB
  119 00000000         ;                      CPSIE i
  120 00000000         ;*******************************************************



ARM Macro Assembler    Page 4 


                       *************************************************
  121 00000000         
  122 00000000         OS_CPU_SR_Save
  123 00000000 B672            CPSID            I           ; Cortex-M7 errata 
                                                            notice. See Note #2
                                                            
  124 00000002 B402            PUSH             {R1}
  125 00000004 F3EF 8111       MRS              R1, BASEPRI
  126 00000008 F380 8811       MSR              BASEPRI, R0
  127 0000000C F3BF 8F4F       DSB
  128 00000010 F3BF 8F6F       ISB
  129 00000014 4608            MOV              R0, R1
  130 00000016 BC02            POP              {R1}
  131 00000018 B662            CPSIE            I
  132 0000001A 4770            BX               LR
  133 0000001C         
  134 0000001C         OS_CPU_SR_Restore
  135 0000001C B672            CPSID            I           ; Cortex-M7 errata 
                                                            notice. See Note #2
                                                            
  136 0000001E F380 8811       MSR              BASEPRI, R0
  137 00000022 F3BF 8F4F       DSB
  138 00000026 F3BF 8F6F       ISB
  139 0000002A B662            CPSIE            I
  140 0000002C 4770            BX               LR
  141 0000002E         
  142 0000002E         
  143 0000002E         ;*******************************************************
                       *************************************************
  144 0000002E         ;                                         START MULTITAS
                       KING
  145 0000002E         ;                                      void OSStartHighR
                       dy(void)
  146 0000002E         ;
  147 0000002E         ; Note(s) : 1) This function triggers a PendSV exception
                        (essentially, causes a context switch) to cause
  148 0000002E         ;              the first task to start.
  149 0000002E         ;
  150 0000002E         ;           2) During task execution, PSP is used as the
                        stack pointer.
  151 0000002E         ;              When an exception occurs, the core will s
                       witch to MSP until the exception return.
  152 0000002E         ;
  153 0000002E         ;           3) OSStartHighRdy() MUST:
  154 0000002E         ;              a) Setup PendSV exception priority to low
                       est;
  155 0000002E         ;              b) Set initial PSP to 0, to tell context 
                       switcher this is first run;
  156 0000002E         ;              c) Set the main stack to OS_CPU_ExceptStk
                       Base
  157 0000002E         ;              d) Set OSRunning to TRUE;
  158 0000002E         ;              e) Get current high priority, OSPrioCur =
                        OSPrioHighRdy;
  159 0000002E         ;              f) Get current ready thread TCB, OSTCBCur
                        = OSTCBHighRdy;
  160 0000002E         ;              g) Get new process SP from TCB, SP = OSTC
                       BHighRdy->OSTCBStkPtr;
  161 0000002E         ;              h) Restore R0-R11 and R14 from new proces
                       s stack;



ARM Macro Assembler    Page 5 


  162 0000002E         ;              i) Enable interrupts (tasks will run with
                        interrupts enabled).
  163 0000002E         ;*******************************************************
                       *************************************************
  164 0000002E         
  165 0000002E         OSStartHighRdy
  166 0000002E B672            CPSID            I           ; Prevent interrupt
                                                            ion during context 
                                                            switch
  167 00000030 484E            LDR              R0, =NVIC_SYSPRI14 ; Set the Pe
                                                            ndSV exception prio
                                                            rity
  168 00000032 F04F 01FF       LDR              R1, =NVIC_PENDSV_PRI
  169 00000036 7001            STRB             R1, [R0]
  170 00000038         
  171 00000038 2000            MOVS             R0, #0      ; Set the PSP to 0 
                                                            for initial context
                                                             switch call
  172 0000003A F380 8809       MSR              PSP, R0
  173 0000003E         
  174 0000003E 484C            LDR              R0, =OS_CPU_ExceptStkBase ; Ini
                                                            tialize the MSP to 
                                                            the OS_CPU_ExceptSt
                                                            kBase
  175 00000040 6801            LDR              R1, [R0]
  176 00000042 F381 8808       MSR              MSP, R1
  177 00000046         
  178 00000046 F7FF FFFE       BL               OSTaskSwHook ; Call OSTaskSwHoo
                                                            k() for FPU Push & 
                                                            Pop
  179 0000004A         
  180 0000004A 484A            LDR              R0, =OSRunning 
                                                            ; OSRunning = TRUE
  181 0000004C 2101            MOVS             R1, #1
  182 0000004E 7001            STRB             R1, [R0]
  183 00000050         
  184 00000050 4849            LDR              R0, =OSPrioCur ; OSPrioCur = OS
                                                            PrioHighRdy;
  185 00000052 494A            LDR              R1, =OSPrioHighRdy
  186 00000054 780A            LDRB             R2, [R1]
  187 00000056 7002            STRB             R2, [R0]
  188 00000058         
  189 00000058 4849            LDR              R0, =OSTCBCur ; OSTCBCur  = OST
                                                            CBHighRdy;
  190 0000005A 494A            LDR              R1, =OSTCBHighRdy
  191 0000005C 680A            LDR              R2, [R1]
  192 0000005E 6002            STR              R2, [R0]
  193 00000060         
  194 00000060 6810            LDR              R0, [R2]    ; R0 is new process
                                                             SP; SP = OSTCBHigh
                                                            Rdy->OSTCBStkPtr;
  195 00000062 F380 8809       MSR              PSP, R0     ; Load PSP with new
                                                             process SP
  196 00000066         
  197 00000066 F3EF 8014       MRS              R0, CONTROL
  198 0000006A F040 0002       ORR              R0, R0, #2
  199 0000006E F380 8814       MSR              CONTROL, R0
  200 00000072 F3BF 8F6F       ISB                          ; Sync instruction 
                                                            stream



ARM Macro Assembler    Page 6 


  201 00000076         
  202 00000076 E8BD 4FF0       LDMFD            SP!, {R4-R11, LR} ; Restore r4-
                                                            11, lr from new pro
                                                            cess stack
  203 0000007A BC0F            LDMFD            SP!, {R0-R3} ; Restore r0, r3
  204 0000007C E8BD 5000       LDMFD            SP!, {R12, LR} 
                                                            ; Load R12 and LR
  205 00000080 BC06            LDMFD            SP!, {R1, R2} ; Load PC and dis
                                                            card xPSR
  206 00000082 B662            CPSIE            I
  207 00000084 4708            BX               R1
  208 00000086         
  209 00000086         
  210 00000086         ;*******************************************************
                       *************************************************
  211 00000086         ;                       PERFORM A CONTEXT SWITCH (From t
                       ask level) - OSCtxSw()
  212 00000086         ;                   PERFORM A CONTEXT SWITCH (From inter
                       rupt level) - OSIntCtxSw()
  213 00000086         ;
  214 00000086         ; Note(s) : 1) OSCtxSw() is called when OS wants to perf
                       orm a task context switch.  This function
  215 00000086         ;              triggers the PendSV exception which is wh
                       ere the real work is done.
  216 00000086         ;
  217 00000086         ;           2) OSIntCtxSw() is called by OSIntExit() whe
                       n it determines a context switch is needed as
  218 00000086         ;              the result of an interrupt.  This functio
                       n simply triggers a PendSV exception which will
  219 00000086         ;              be handled when there are no more interru
                       pts active and interrupts are enabled.
  220 00000086         ;*******************************************************
                       *************************************************
  221 00000086         
  222 00000086         OSCtxSw
  223 00000086         OSIntCtxSw
  224 00000086         
  225 00000086 4840            LDR              R0, =NVIC_INT_CTRL ; Trigger th
                                                            e PendSV exception 
                                                            (causes context swi
                                                            tch)
  226 00000088 F04F 5180       LDR              R1, =NVIC_PENDSVSET
  227 0000008C 6001            STR              R1, [R0]
  228 0000008E 4770            BX               LR
  229 00000090         
  230 00000090         
  231 00000090         ;*******************************************************
                       *************************************************
  232 00000090         ;                                       HANDLE PendSV EX
                       CEPTION
  233 00000090         ;                                   void OS_CPU_PendSVHa
                       ndler(void)
  234 00000090         ;
  235 00000090         ; Note(s) : 1) PendSV is used to cause a context switch.
                         This is a recommended method for performing
  236 00000090         ;              context switches with Cortex-M.  This is 
                       because the Cortex-M auto-saves half of the
  237 00000090         ;              processor context on any exception, and r
                       estores same on return from exception.  So only



ARM Macro Assembler    Page 7 


  238 00000090         ;              saving of R4-R11 & R14 is required and fi
                       xing up the stack pointers. Using the PendSV exception
  239 00000090         ;              this way means that context saving and re
                       storing is identical whether it is initiated from
  240 00000090         ;              a thread or occurs due to an interrupt or
                        exception.
  241 00000090         ;
  242 00000090         ;           2) Pseudo-code is:
  243 00000090         ;              a) Get the process SP
  244 00000090         ;              b) Save remaining regs r4-r11 & r14 on pr
                       ocess stack;
  245 00000090         ;              c) Save the process SP in its TCB, OSTCBC
                       ur->OSTCBStkPtr = SP;
  246 00000090         ;              d) Call OSTaskSwHook();
  247 00000090         ;              e) Get current high priority, OSPrioCur =
                        OSPrioHighRdy;
  248 00000090         ;              f) Get current ready thread TCB, OSTCBCur
                        = OSTCBHighRdy;
  249 00000090         ;              g) Get new process SP from TCB, SP = OSTC
                       BHighRdy->OSTCBStkPtr;
  250 00000090         ;              h) Restore R4-R11 and R14 from new proces
                       s stack;
  251 00000090         ;              i) Perform exception return which will re
                       store remaining context.
  252 00000090         ;
  253 00000090         ;           3) On entry into PendSV handler:
  254 00000090         ;              a) The following have been saved on the p
                       rocess stack (by processor):
  255 00000090         ;                 xPSR, PC, LR, R12, R0-R3
  256 00000090         ;              b) Processor mode is switched to Handler 
                       mode (from Thread mode)
  257 00000090         ;              c) Stack is Main stack (switched from Pro
                       cess stack)
  258 00000090         ;              d) OSTCBCur      points to the OS_TCB of 
                       the task to suspend
  259 00000090         ;                 OSTCBHighRdy  points to the OS_TCB of 
                       the task to resume
  260 00000090         ;
  261 00000090         ;           4) Since PendSV is set to lowest priority in
                        the system (by OSStartHighRdy() above), we
  262 00000090         ;              know that it will only be run when no oth
                       er exception or interrupt is active, and
  263 00000090         ;              therefore safe to assume that context bei
                       ng switched out was using the process stack (PSP).
  264 00000090         ;
  265 00000090         ;           5) Increasing priority using a write to BASE
                       PRI does not take effect immediately.
  266 00000090         ;              (a) IMPLICATION  This erratum means that 
                       the instruction after an MSR to boost BASEPRI
  267 00000090         ;                  might incorrectly be preempted by an 
                       insufficient high priority exception.
  268 00000090         ;
  269 00000090         ;              (b) WORKAROUND  The MSR to boost BASEPRI 
                       can be replaced by the following code sequence:
  270 00000090         ;
  271 00000090         ;                  CPSID i
  272 00000090         ;                  MSR to BASEPRI
  273 00000090         ;                  DSB
  274 00000090         ;                  ISB



ARM Macro Assembler    Page 8 


  275 00000090         ;                  CPSIE i
  276 00000090         ;*******************************************************
                       *************************************************
  277 00000090         
  278 00000090         PendSV_Handler
  279 00000090         ;CPSID   I                                              
                            ; Cortex-M7 errata notice. See Note #5
  280 00000090         ;MOV32   R2, OS_KA_BASEPRI_Boundary                     
                            ; Set BASEPRI priority level required for exception
                        preemption
  281 00000090         ;LDR     R1, [R2]
  282 00000090         ;MSR     BASEPRI, R1
  283 00000090         ;DSB
  284 00000090         ;ISB
  285 00000090         ;CPSIE   I
  286 00000090         
  287 00000090 F3EF 8009       MRS              R0, PSP     ; PSP is process st
                                                            ack pointer
  288 00000094 E920 4FF0       STMFD            R0!, {R4-R11, R14} ; Save remai
                                                            ning regs r4-11, R1
                                                            4 on process stack
  289 00000098         
  290 00000098 4D39            LDR              R5, =OSTCBCur ; OSTCBCur->OSTCB
                                                            StkPtr = SP;
  291 0000009A 6829            LDR              R1, [R5]
  292 0000009C 6008            STR              R0, [R1]    ; R0 is SP of proce
                                                            ss being switched o
                                                            ut
  293 0000009E         
  294 0000009E         ; At this point, entire context of process has been save
                       d
  295 0000009E 4674            MOV              R4, LR      ; Save LR exc_retur
                                                            n value
  296 000000A0 F7FF FFFE       BL               OSTaskSwHook ; Call OSTaskSwHoo
                                                            k() for FPU Push & 
                                                            Pop
  297 000000A4         
  298 000000A4 4834            LDR              R0, =OSPrioCur ; OSPrioCur = OS
                                                            PrioHighRdy;
  299 000000A6 4935            LDR              R1, =OSPrioHighRdy
  300 000000A8 780A            LDRB             R2, [R1]
  301 000000AA 7002            STRB             R2, [R0]
  302 000000AC         
  303 000000AC 4935            LDR              R1, =OSTCBHighRdy ; OSTCBCur  =
                                                             OSTCBHighRdy;
  304 000000AE 680A            LDR              R2, [R1]
  305 000000B0 602A            STR              R2, [R5]
  306 000000B2         
  307 000000B2 F044 0E04       ORR              LR,  R4, #0x04 ; Ensure excepti
                                                            on return uses proc
                                                            ess stack
  308 000000B6 6810            LDR              R0,  [R2]   ; R0 is new process
                                                             SP; SP = OSTCBHigh
                                                            Rdy->OSTCBStkPtr;
  309 000000B8 E8B0 4FF0       LDMFD            R0!, {R4-R11, R14} ; Restore r4
                                                            -11, R14 from new p
                                                            rocess stack
  310 000000BC F380 8809       MSR              PSP, R0     ; Load PSP with new
                                                             process SP



ARM Macro Assembler    Page 9 


  311 000000C0         
  312 000000C0 F240 0200 
              F2C0 0200        MOV32            R2, #0      ; Restore BASEPRI p
                                                            riority level to 0
  313 000000C8 B672            CPSID            I
  314 000000CA F382 8811       MSR              BASEPRI, R2
  315 000000CE F3BF 8F4F       DSB
  316 000000D2 F3BF 8F6F       ISB
  317 000000D6 B662            CPSIE            I
  318 000000D8 4770            BX               LR          ; Exception return 
                                                            will restore remain
                                                            ing context
  319 000000DA         
  320 000000DA 40023800 
                       RCC_BASE
                               EQU              0x40023800
  321 000000DA 40023800 
                       RCC_CR  EQU              RCC_BASE + 0x00
  322 000000DA 40023804 
                       RCC_PLLCFGR
                               EQU              RCC_BASE + 0x04
  323 000000DA 40023808 
                       RCC_CFGR
                               EQU              RCC_BASE + 0x08
  324 000000DA 40023830 
                       RCC_AHB1ENR
                               EQU              RCC_BASE + 0x30
  325 000000DA 40023C00 
                       FLASH_ACR
                               EQU              0x40023C00
  326 000000DA E000E010 
                       SYSTICK_BASE
                               EQU              0xE000E010
  327 000000DA E000E010 
                       SYSTICK_CTRL
                               EQU              SYSTICK_BASE + 0x00
  328 000000DA E000E014 
                       SYSTICK_LOAD
                               EQU              SYSTICK_BASE + 0x04
  329 000000DA E000E018 
                       SYSTICK_VAL
                               EQU              SYSTICK_BASE + 0x08
  330 000000DA         
  331 000000DA E000ED20 
                       SCB_SHPR3
                               EQU              0xE000ED20
  332 000000DA         
  333 000000DA         SystemInit1
  334 000000DA 482C            LDR              R0, =RCC_CR
  335 000000DC 6801            LDR              R1, [R0]    ; ¶ÁÈ¡µ±Ç°RCC_CRµÄÖ
                                                            µ
  336 000000DE F441 21A0       ORR              R1, R1, #(1 << 16) :or: (1 << 1
8) 
                                                            ; ÆôÓÃHSEON£¨²»Çå³ý
                                                            ÆäËûÎ»£©
  337 000000E2         ; ÈôÊ¹ÓÃÍâ²¿Ê±ÖÓÔ´£¬Ìí¼Ó£ºORR R1, R1, #(1 << 18) ; ·ñÔò×
                       ¢ÊÍ´ËÐÐ
  338 000000E2 6001            STR              R1, [R0]
  339 000000E4         



ARM Macro Assembler    Page 10 


  340 000000E4         Wait_HSE_Ready
  341 000000E4 6801            LDR              R1, [R0]
  342 000000E6 F411 3F00       TST              R1, #(1 << 17)
  343 000000EA D0FB            BEQ              Wait_HSE_Ready
  344 000000EC         
  345 000000EC         ;---------------------------------------------
  346 000000EC         ; 2. 
  347 000000EC         ;---------------------------------------------
  348 000000EC 4828            LDR              R0, =FLASH_ACR
  349 000000EE F04F 0102       MOV              R1, #0x02
  350 000000F2 6001            STR              R1, [R0]
  351 000000F4         
  352 000000F4         ;---------------------------------------------
  353 000000F4         ; 3. 
  354 000000F4         ;---------------------------------------------
  355 000000F4 4827            LDR              R0, =RCC_PLLCFGR
  356 000000F6 F04F 0100       MOV              R1, #0x00000000
  357 000000FA F041 0108       ORR              R1, R1, #(8 << 0) ; PLLM = 16 (
                                                            bits 5:0)
  358 000000FE F441 41A8       ORR              R1, R1, #(336 << 6) ; PLLN = 33
                                                            6 (bits 14:6)
  359 00000102 F441 3180       ORR              R1, R1, #(1<< 16) 
                                                            ; PLLP = 0b00 
  360 00000106 F441 0180       ORR              R1, R1, #(1 << 22) 
                                                            ; PLLSRC = 1 
  361 0000010A 6001            STR              R1, [R0]
  362 0000010C         
  363 0000010C         ;---------------------------------------------
  364 0000010C         ; 4. 
  365 0000010C         ;---------------------------------------------
  366 0000010C 481F            LDR              R0, =RCC_CR
  367 0000010E 6801            LDR              R1, [R0]
  368 00000110 F041 7180       ORR              R1, R1, #(1 << 24)
  369 00000114 6001            STR              R1, [R0]
  370 00000116         
  371 00000116         Wait_PLL_Ready
  372 00000116 6801            LDR              R1, [R0]
  373 00000118 F011 7F00       TST              R1, #(1 << 25)
  374 0000011C D0FB            BEQ              Wait_PLL_Ready
  375 0000011E         
  376 0000011E         ;---------------------------------------------
  377 0000011E         ; 5. 
  378 0000011E         ;---------------------------------------------
  379 0000011E 481E            LDR              R0, =RCC_CFGR
  380 00000120 F04F 0100       MOV              R1, #0x00000000
  381 00000124 F041 0100       ORR              R1, R1, #(0 << 4) ; HPRE=0 
  382 00000128 F441 5180       ORR              R1, R1, #(0x4 << 10) 
                                                            ; PPRE1=0b100 
  383 0000012C F041 0100       ORR              R1, R1, #(0 << 13) ; PPRE2=0 
  384 00000130 F041 0102       ORR              R1, R1, #(2 << 0) ; SW=0b10 
  385 00000134 6001            STR              R1, [R0]
  386 00000136         
  387 00000136         Wait_Clock_Switch
  388 00000136 6801            LDR              R1, [R0]
  389 00000138 F001 020C       AND              R2, R1, #0xC
  390 0000013C 2A08            CMP              R2, #0x8
  391 0000013E D1FA            BNE              Wait_Clock_Switch
  392 00000140         
  393 00000140         ;---------------------------------------------



ARM Macro Assembler    Page 11 


  394 00000140         ; 6. 
  395 00000140         ;---------------------------------------------
  396 00000140         
  397 00000140 4816            LDR              R0, =0xE000E010
  398 00000142 F04F 0100       MOV              R1, #0x00000000
  399 00000146 F041 0105       ORR              R1, #5
  400 0000014A 6001            STR              R1, [R0]
  401 0000014C         
  402 0000014C 4813            LDR              R0, =SYSTICK_BASE
  403 0000014E 4914            LDR              R1, =83999
  404 00000150 6041            STR              R1, [R0, #0x04]
  405 00000152 F04F 0100       MOV              R1, #0
  406 00000156 6081            STR              R1, [R0, #0x08]
  407 00000158 F04F 0107       MOV              R1, #0x07
  408 0000015C 6001            STR              R1, [R0, #0x00]
  409 0000015E         
  410 0000015E 4811            LDR              R0,=SCB_SHPR3
  411 00000160 F041 61A0       ORR              R1, #(0x5 << 24)
  412 00000164 6001            STR              R1, [R0]
  413 00000166         
  414 00000166 B662            CPSIE            I
  415 00000168         
  416 00000168 4770            BX               LR
  417 0000016A         
  418 0000016A 00 00           ALIGN                        ; Removes warning[A
                                                            1581W]: added <no_p
                                                            adbytes> of padding
                                                             at <address>
  419 0000016C         
  420 0000016C                 END
              E000ED22 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              E000ED04 
              40023800 
              40023C00 
              40023804 
              40023808 
              E000E010 
              0001481F 
              E000ED20 
Command Line: --debug --xref --diag_suppress=9931 --cpu=Cortex-M3 --apcs=interw
ork --depend=.\objects\os_cpu_a.d -o.\objects\os_cpu_a.o -I.\RTE\_Target_1 -IC:
\download\Keil5\ARM\PACK\Keil\STM32F1xx_DFP\2.2.0\Device\Include -IC:\download\
Keil5\ARM\CMSIS\Include --predefine="__EVAL SETA 1" --predefine="__UVISION_VERS
ION SETA 527" --predefine="STM32F10X_MD SETA 1" --list=.\listings\os_cpu_a.lst 
Ports\os_cpu_a.asm



ARM Macro Assembler    Page 1 Alphabetic symbol ordering
Relocatable symbols

.text 00000000

Symbol: .text
   Definitions
      At line 71 in file Ports\os_cpu_a.asm
   Uses
      None
Comment: .text unused
OSCtxSw 00000086

Symbol: OSCtxSw
   Definitions
      At line 222 in file Ports\os_cpu_a.asm
   Uses
      At line 50 in file Ports\os_cpu_a.asm
Comment: OSCtxSw used once
OSIntCtxSw 00000086

Symbol: OSIntCtxSw
   Definitions
      At line 223 in file Ports\os_cpu_a.asm
   Uses
      At line 51 in file Ports\os_cpu_a.asm
Comment: OSIntCtxSw used once
OSStartHighRdy 0000002E

Symbol: OSStartHighRdy
   Definitions
      At line 165 in file Ports\os_cpu_a.asm
   Uses
      At line 47 in file Ports\os_cpu_a.asm
Comment: OSStartHighRdy used once
OS_CPU_SR_Restore 0000001C

Symbol: OS_CPU_SR_Restore
   Definitions
      At line 134 in file Ports\os_cpu_a.asm
   Uses
      At line 49 in file Ports\os_cpu_a.asm
Comment: OS_CPU_SR_Restore used once
OS_CPU_SR_Save 00000000

Symbol: OS_CPU_SR_Save
   Definitions
      At line 122 in file Ports\os_cpu_a.asm
   Uses
      At line 48 in file Ports\os_cpu_a.asm
Comment: OS_CPU_SR_Save used once
PendSV_Handler 00000090

Symbol: PendSV_Handler
   Definitions
      At line 278 in file Ports\os_cpu_a.asm
   Uses
      At line 52 in file Ports\os_cpu_a.asm
Comment: PendSV_Handler used once
SystemInit1 000000DA

Symbol: SystemInit1



ARM Macro Assembler    Page 2 Alphabetic symbol ordering
Relocatable symbols

   Definitions
      At line 333 in file Ports\os_cpu_a.asm
   Uses
      At line 53 in file Ports\os_cpu_a.asm
Comment: SystemInit1 used once
Wait_Clock_Switch 00000136

Symbol: Wait_Clock_Switch
   Definitions
      At line 387 in file Ports\os_cpu_a.asm
   Uses
      At line 391 in file Ports\os_cpu_a.asm
Comment: Wait_Clock_Switch used once
Wait_HSE_Ready 000000E4

Symbol: Wait_HSE_Ready
   Definitions
      At line 340 in file Ports\os_cpu_a.asm
   Uses
      At line 343 in file Ports\os_cpu_a.asm
Comment: Wait_HSE_Ready used once
Wait_PLL_Ready 00000116

Symbol: Wait_PLL_Ready
   Definitions
      At line 371 in file Ports\os_cpu_a.asm
   Uses
      At line 374 in file Ports\os_cpu_a.asm
Comment: Wait_PLL_Ready used once
11 symbols



ARM Macro Assembler    Page 1 Alphabetic symbol ordering
Absolute symbols

FLASH_ACR 40023C00

Symbol: FLASH_ACR
   Definitions
      At line 325 in file Ports\os_cpu_a.asm
   Uses
      At line 348 in file Ports\os_cpu_a.asm
Comment: FLASH_ACR used once
NVIC_INT_CTRL E000ED04

Symbol: NVIC_INT_CTRL
   Definitions
      At line 61 in file Ports\os_cpu_a.asm
   Uses
      At line 225 in file Ports\os_cpu_a.asm
Comment: NVIC_INT_CTRL used once
NVIC_PENDSVSET 10000000

Symbol: NVIC_PENDSVSET
   Definitions
      At line 64 in file Ports\os_cpu_a.asm
   Uses
      At line 226 in file Ports\os_cpu_a.asm
Comment: NVIC_PENDSVSET used once
NVIC_PENDSV_PRI 000000FF

Symbol: NVIC_PENDSV_PRI
   Definitions
      At line 63 in file Ports\os_cpu_a.asm
   Uses
      At line 168 in file Ports\os_cpu_a.asm
Comment: NVIC_PENDSV_PRI used once
NVIC_SYSPRI14 E000ED22

Symbol: NVIC_SYSPRI14
   Definitions
      At line 62 in file Ports\os_cpu_a.asm
   Uses
      At line 167 in file Ports\os_cpu_a.asm
Comment: NVIC_SYSPRI14 used once
RCC_AHB1ENR 40023830

Symbol: RCC_AHB1ENR
   Definitions
      At line 324 in file Ports\os_cpu_a.asm
   Uses
      None
Comment: RCC_AHB1ENR unused
RCC_BASE 40023800

Symbol: RCC_BASE
   Definitions
      At line 320 in file Ports\os_cpu_a.asm
   Uses
      At line 321 in file Ports\os_cpu_a.asm
      At line 322 in file Ports\os_cpu_a.asm
      At line 323 in file Ports\os_cpu_a.asm
      At line 324 in file Ports\os_cpu_a.asm




ARM Macro Assembler    Page 2 Alphabetic symbol ordering
Absolute symbols

RCC_CFGR 40023808

Symbol: RCC_CFGR
   Definitions
      At line 323 in file Ports\os_cpu_a.asm
   Uses
      At line 379 in file Ports\os_cpu_a.asm
Comment: RCC_CFGR used once
RCC_CR 40023800

Symbol: RCC_CR
   Definitions
      At line 321 in file Ports\os_cpu_a.asm
   Uses
      At line 334 in file Ports\os_cpu_a.asm
      At line 366 in file Ports\os_cpu_a.asm

RCC_PLLCFGR 40023804

Symbol: RCC_PLLCFGR
   Definitions
      At line 322 in file Ports\os_cpu_a.asm
   Uses
      At line 355 in file Ports\os_cpu_a.asm
Comment: RCC_PLLCFGR used once
SCB_SHPR3 E000ED20

Symbol: SCB_SHPR3
   Definitions
      At line 331 in file Ports\os_cpu_a.asm
   Uses
      At line 410 in file Ports\os_cpu_a.asm
Comment: SCB_SHPR3 used once
SYSTICK_BASE E000E010

Symbol: SYSTICK_BASE
   Definitions
      At line 326 in file Ports\os_cpu_a.asm
   Uses
      At line 327 in file Ports\os_cpu_a.asm
      At line 328 in file Ports\os_cpu_a.asm
      At line 329 in file Ports\os_cpu_a.asm
      At line 402 in file Ports\os_cpu_a.asm

SYSTICK_CTRL E000E010

Symbol: SYSTICK_CTRL
   Definitions
      At line 327 in file Ports\os_cpu_a.asm
   Uses
      None
Comment: SYSTICK_CTRL unused
SYSTICK_LOAD E000E014

Symbol: SYSTICK_LOAD
   Definitions
      At line 328 in file Ports\os_cpu_a.asm
   Uses
      None



ARM Macro Assembler    Page 3 Alphabetic symbol ordering
Absolute symbols

Comment: SYSTICK_LOAD unused
SYSTICK_VAL E000E018

Symbol: SYSTICK_VAL
   Definitions
      At line 329 in file Ports\os_cpu_a.asm
   Uses
      None
Comment: SYSTICK_VAL unused
15 symbols



ARM Macro Assembler    Page 1 Alphabetic symbol ordering
External symbols

OSIntExit 00000000

Symbol: OSIntExit
   Definitions
      At line 41 in file Ports\os_cpu_a.asm
   Uses
      None
Comment: OSIntExit unused
OSPrioCur 00000000

Symbol: OSPrioCur
   Definitions
      At line 37 in file Ports\os_cpu_a.asm
   Uses
      At line 184 in file Ports\os_cpu_a.asm
      At line 298 in file Ports\os_cpu_a.asm

OSPrioHighRdy 00000000

Symbol: OSPrioHighRdy
   Definitions
      At line 38 in file Ports\os_cpu_a.asm
   Uses
      At line 185 in file Ports\os_cpu_a.asm
      At line 299 in file Ports\os_cpu_a.asm

OSRunning 00000000

Symbol: OSRunning
   Definitions
      At line 36 in file Ports\os_cpu_a.asm
   Uses
      At line 180 in file Ports\os_cpu_a.asm
Comment: OSRunning used once
OSTCBCur 00000000

Symbol: OSTCBCur
   Definitions
      At line 39 in file Ports\os_cpu_a.asm
   Uses
      At line 189 in file Ports\os_cpu_a.asm
      At line 290 in file Ports\os_cpu_a.asm

OSTCBHighRdy 00000000

Symbol: OSTCBHighRdy
   Definitions
      At line 40 in file Ports\os_cpu_a.asm
   Uses
      At line 190 in file Ports\os_cpu_a.asm
      At line 303 in file Ports\os_cpu_a.asm

OSTaskSwHook 00000000

Symbol: OSTaskSwHook
   Definitions
      At line 42 in file Ports\os_cpu_a.asm
   Uses
      At line 178 in file Ports\os_cpu_a.asm



ARM Macro Assembler    Page 2 Alphabetic symbol ordering
External symbols

      At line 296 in file Ports\os_cpu_a.asm

OS_CPU_ExceptStkBase 00000000

Symbol: OS_CPU_ExceptStkBase
   Definitions
      At line 43 in file Ports\os_cpu_a.asm
   Uses
      At line 174 in file Ports\os_cpu_a.asm
Comment: OS_CPU_ExceptStkBase used once
OS_KA_BASEPRI_Boundary 00000000

Symbol: OS_KA_BASEPRI_Boundary
   Definitions
      At line 44 in file Ports\os_cpu_a.asm
   Uses
      None
Comment: OS_KA_BASEPRI_Boundary unused
9 symbols
370 symbols in table
